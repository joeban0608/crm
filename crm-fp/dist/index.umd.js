(function(i,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(i=typeof globalThis<"u"?globalThis:i||self,s(i.CRMFingerprint={}))})(this,function(i){"use strict";var xt=Object.defineProperty;var st=i=>{throw TypeError(i)};var Ot=(i,s,o)=>s in i?xt(i,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[s]=o;var d=(i,s,o)=>Ot(i,typeof s!="symbol"?s+"":s,o),nt=(i,s,o)=>s.has(i)||st("Cannot "+o);var e=(i,s,o)=>(nt(i,s,"read from private field"),o?o.call(i):s.get(i)),f=(i,s,o)=>s.has(i)?st("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(i):s.set(i,o),g=(i,s,o,D)=>(nt(i,s,"write to private field"),D?D.call(i,o):s.set(i,o),o),H=(i,s,o)=>(nt(i,s,"access private method"),o);var F,$,U,A,ot,ut,p,R,x,E,O,j,k,L,M,T,V,b,P,S,J,lt;const s="http://192.168.0.73:5173";function o(a){function t(h,y){return h>>>y|h<<32-y}const n=new TextEncoder().encode(a),r=Array.from(n),u=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],l=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],w=r.length*8;for(r.push(128);(r.length*8+64)%512!==0;)r.push(0);const N=new Array(8).fill(0);for(let h=0;h<8;h++)N[7-h]=w>>>h*8&255;r.push(...N);const it=[];for(let h=0;h<r.length;h+=64)it.push(r.slice(h,h+64));return it.forEach(h=>{const y=new Array(64);for(let c=0;c<16;c++)y[c]=h[c*4]<<24|h[c*4+1]<<16|h[c*4+2]<<8|h[c*4+3];for(let c=16;c<64;c++){const tt=t(y[c-15],7)^t(y[c-15],18)^y[c-15]>>>3,et=t(y[c-2],17)^t(y[c-2],19)^y[c-2]>>>10;y[c]=y[c-16]+tt+y[c-7]+et|0}let[C,I,z,X,v,_,G,Y]=l;for(let c=0;c<64;c++){const tt=t(v,6)^t(v,11)^t(v,25),et=v&_^~v&G,rt=Y+tt+et+u[c]+y[c]|0,Tt=t(C,2)^t(C,13)^t(C,22),At=C&I^C&z^I&z,Rt=Tt+At|0;Y=G,G=_,_=v,v=X+rt|0,X=z,z=I,I=C,C=rt+Rt|0}l[0]=l[0]+C|0,l[1]=l[1]+I|0,l[2]=l[2]+z|0,l[3]=l[3]+X|0,l[4]=l[4]+v|0,l[5]=l[5]+_|0,l[6]=l[6]+G|0,l[7]=l[7]+Y|0}),l.map(h=>(h>>>0).toString(16).padStart(8,"0")).join("")}class D{constructor(){f(this,A);d(this,"name","Audio Feature");d(this,"enabled",!0);f(this,F,null);f(this,$,null);f(this,U,5e3)}async support(){const t=window.OfflineAudioContext||window.webkitOfflineAudioContext;return t?(g(this,F,new t(1,e(this,U),44100)),e(this,F)!==null):!1}async data(){if(e(this,F)===null)return null;const t=await H(this,A,ot).call(this,e(this,F));return t===null?null:(g(this,$,t.toString()),{fingerprint:await o(e(this,$)),info:{audio:t}})}}F=new WeakMap,$=new WeakMap,U=new WeakMap,A=new WeakSet,ot=function(t){return new Promise(n=>{const r=t.createOscillator();r.type="triangle",r.frequency.value=1e4;const u=t.createDynamicsCompressor();u.threshold.value=-50,u.knee.value=40,u.ratio.value=12,u.attack.value=0,u.release.value=.2,r.connect(u),u.connect(t.destination),r.start(),t.oncomplete=l=>{const w=l.renderedBuffer.getChannelData(0),N=H(this,A,ut).call(this,w);n(N)},t.startRendering()})},ut=function(t){let n=0;for(let r=0;r<t.length;++r)n+=Math.abs(t[r]);return n};class ct{constructor(){d(this,"name","Canvas Feature");d(this,"enabled",!0);f(this,p,null);f(this,R,null)}async support(){return document?(g(this,p,document.createElement("canvas").getContext("2d")),e(this,p)!==null):!1}async data(){return e(this,p)===null?null:(e(this,p).textBaseline="top",e(this,p).font="14px 'Arial'",e(this,p).textBaseline="alphabetic",e(this,p).fillStyle="#f60",e(this,p).fillRect(100,1,55,20),e(this,p).fillStyle="#069",e(this,p).fillText("Cyber Universe Canvas",2,15),e(this,p).fillStyle="rgba(102, 204, 0, 0.7)",e(this,p).fillText("Cyber Universe Canvas",4,17),g(this,R,e(this,p).canvas.toDataURL()),{fingerprint:await o(e(this,R)),info:{image:e(this,R)}})}}p=new WeakMap,R=new WeakMap;const q=class q{constructor(){d(this,"name","ColorGamut Feature");d(this,"enabled",!0);f(this,x,null);f(this,E,null)}async support(){return!0}async data(){for(const t of q.gamutList){const n=`(color-gamut: ${t})`;if(matchMedia(n).matches){g(this,x,`gamut: ${t}`),g(this,E,t);break}}return e(this,x)===null?null:{fingerprint:await o(e(this,x)),info:{colorGamut:e(this,E)}}}};x=new WeakMap,E=new WeakMap,d(q,"gamutList",["rec2020","p3","srgb"]);let Q=q;class ft{constructor(){d(this,"name","Hardware Concurrency Feature");d(this,"enabled",!0);f(this,O,null);f(this,j,null);f(this,k,null)}async support(){return!!navigator}async data(){return navigator.hardwareConcurrency&&(g(this,O,navigator.hardwareConcurrency.toString()),g(this,k,navigator.hardwareConcurrency)),e(this,O)?(g(this,j,"hardware concurrency: "+e(this,O)),{fingerprint:await o(e(this,j)),info:{hardwareConcurrency:e(this,k)}}):null}}O=new WeakMap,j=new WeakMap,k=new WeakMap;const B=class B{constructor(){d(this,"name","HDR Feature");d(this,"enabled",!0);f(this,L,null);f(this,M,null)}async support(){return!0}async data(){for(const t of B.hdrList){const n=`(dynamic-range: ${t})`;if(matchMedia(n).matches){g(this,L,`dynamic-range: ${t}`),g(this,M,t);break}}return e(this,L)===null?null:{fingerprint:await o(e(this,L)),info:{hdr:e(this,M)}}}};L=new WeakMap,M=new WeakMap,d(B,"hdrList",["high","standard"]);let K=B;class ht{constructor(){d(this,"name","Languages Feature");d(this,"enabled",!0);f(this,T,[]);f(this,V,null)}async support(){return!!navigator}async data(){var t;return navigator.language&&e(this,T).push([navigator.language]),Array.isArray(navigator.languages)&&e(this,T).push(navigator.languages),(t=e(this,T))!=null&&t.length?(g(this,V,JSON.stringify(e(this,T))),{fingerprint:await o(e(this,V)),info:{languages:e(this,V)}}):null}}T=new WeakMap,V=new WeakMap;class dt{constructor(){d(this,"name","Screen resolution Feature");d(this,"enabled",!0);f(this,b,null);f(this,P,null)}async support(){if(!(window.OfflineAudioContext||window.webkitOfflineAudioContext))return!1;const n=window.screen;return n?(g(this,b,n),e(this,b)!==null):!1}async data(){if(e(this,b)===null)return null;const t=`${e(this,b).width} x ${e(this,b).height}`;return g(this,P,t),{fingerprint:await o(e(this,P)),info:{screenResolution:t}}}}b=new WeakMap,P=new WeakMap;class gt{constructor(){f(this,J);d(this,"name","Timezone Feature");d(this,"enabled",!0);f(this,S,null)}async support(){return!0}async data(){if(Intl.DateTimeFormat){const t=new Intl.DateTimeFormat().resolvedOptions().timeZone;g(this,S,t)}else g(this,S,H(this,J,lt).call(this));return e(this,S)===null?null:{fingerprint:await o(e(this,S)),info:{timezone:e(this,S)}}}}S=new WeakMap,J=new WeakSet,lt=function(){const n=-new Date().getTimezoneOffset(),r=n>=0?"+":"-",u=Math.floor(Math.abs(n)/60).toString().padStart(2,"0"),l=(Math.abs(n)%60).toString().padStart(2,"0");return`UTC${r}${u}:${l}`};let Z;const W=[];function pt(a){if(window.pako)return window.pako.deflate(JSON.stringify(a));throw new Error("pako is not defined")}async function wt(a){const t=a.id;if(!t)throw new Error("visitorId is required when tracking");Z=Date.now(),console.log("sendPageView init"),at(t,"init"),window.addEventListener("beforeunload",()=>{console.log("beforeunload"),at(t,"beforeunload")})}function at(a,t){const n=Date.now(),r=Math.round((n-Z)/1e3);W.push({type:"pageView",createAt:new Date().toISOString(),details:{url:window.location.href,duration:r,viewType:t}}),yt({visitorId:a,eventLogs:W}),W.length=0,Z=Date.now()}async function yt(a,t="projects/seo-manager-429705/topics/fp-test"){try{const r=await(await fetch(`${s}/api/pubsub/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic_name_or_id:t,message:pt(a)})})).json();return console.log("getLogRes",r),r}catch(n){console.error("Error sending logs:",n)}}const mt=async a=>a.enabled?await a.support()?await a.data():(console.log(`Feature ${a.name} is not supported`),null):(console.log(`Feature ${a.name} is disabled`),null),bt=async()=>{const a=await St();return await(await(await Ft(a)).json()).data},St=async()=>{const a=[new D,new ct,new Q,new K,new ft,new ht,new dt,new gt],t=[],n={},r={};for(const l of a){const w=await mt(l);await m(w,"audio","audio",n),await m(w,"canvas","image",n),await m(w,"color gamut","colorGamut",n),await m(w,"hdr","hdr",n),await m(w,"hardware concurrency","hardwareConcurrency",n),await m(w,"languages","languages",n),await m(w,"screen resolution","screenResolution",n),await m(w,"timezone","timezone",n),w!=null&&w.fingerprint&&t.push(w.fingerprint)}const u=await vt();return u&&await Ct(r,t,u),{id:await o(JSON.stringify(t)),ip:(u==null?void 0:u.ip)||!1,useragent:(u==null?void 0:u.headers["user-agent"])||!1,headers:(u==null?void 0:u.headers)||!1,rawData:n,serverFeature:r}};function m(a,t,n,r){var u;(u=a==null?void 0:a.info)!=null&&u[n]&&(r[t]={hash:a.fingerprint,value:a.info[n]})}async function Ct(a,t,n){if(n!=null&&n.ip){const r=await o(n.ip);a["client ip"]={hash:r,value:n.ip},t.push(r)}}async function vt(){try{const t=await(await fetch(`${s}/api/fingerprint`)).json();if(!t)throw new Error("failed to get user request info");return t.serverData}catch(a){console.error("failed to get user request info",a)}}async function Ft(a){return fetch(`${s}/api/fingerprint`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}i.fpPromise=bt,i.tracking=wt,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
