(function(i,r){typeof exports=="object"&&typeof module<"u"?r(exports):typeof define=="function"&&define.amd?define(["exports"],r):(i=typeof globalThis<"u"?globalThis:i||self,r(i.CRMFingerprint={}))})(this,function(i){"use strict";var Re=Object.defineProperty;var oe=i=>{throw TypeError(i)};var ke=(i,r,s)=>r in i?Re(i,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[r]=s;var d=(i,r,s)=>ke(i,typeof r!="symbol"?r+"":r,s),ae=(i,r,s)=>r.has(i)||oe("Cannot "+s);var n=(i,r,s)=>(ae(i,r,"read from private field"),s?s.call(i):r.get(i)),f=(i,r,s)=>r.has(i)?oe("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(i):r.set(i,s),g=(i,r,s,U)=>(ae(i,r,"write to private field"),U?U.call(i,s):r.set(i,s),s),H=(i,r,s)=>(ae(i,r,"access private method"),s);var A,$,N,O,le,ue,p,T,R,E,k,M,I,V,P,x,L,b,z,S,B,ce;const r="http://192.168.0.73:5173";function s(t){function e(h,y){return h>>>y|h<<32-y}const a=new TextEncoder().encode(t),o=Array.from(a),l=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],u=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],w=o.length*8;for(o.push(128);(o.length*8+64)%512!==0;)o.push(0);const J=new Array(8).fill(0);for(let h=0;h<8;h++)J[7-h]=w>>>h*8&255;o.push(...J);const re=[];for(let h=0;h<o.length;h+=64)re.push(o.slice(h,h+64));return re.forEach(h=>{const y=new Array(64);for(let c=0;c<16;c++)y[c]=h[c*4]<<24|h[c*4+1]<<16|h[c*4+2]<<8|h[c*4+3];for(let c=16;c<64;c++){const te=e(y[c-15],7)^e(y[c-15],18)^y[c-15]>>>3,ne=e(y[c-2],17)^e(y[c-2],19)^y[c-2]>>>10;y[c]=y[c-16]+te+y[c-7]+ne|0}let[v,D,j,Y,C,_,G,ee]=u;for(let c=0;c<64;c++){const te=e(C,6)^e(C,11)^e(C,25),ne=C&_^~C&G,se=ee+te+ne+l[c]+y[c]|0,xe=e(v,2)^e(v,13)^e(v,22),Oe=v&D^v&j^D&j,Te=xe+Oe|0;ee=G,G=_,_=C,C=Y+se|0,Y=j,j=D,D=v,v=se+Te|0}u[0]=u[0]+v|0,u[1]=u[1]+D|0,u[2]=u[2]+j|0,u[3]=u[3]+Y|0,u[4]=u[4]+C|0,u[5]=u[5]+_|0,u[6]=u[6]+G|0,u[7]=u[7]+ee|0}),u.map(h=>(h>>>0).toString(16).padStart(8,"0")).join("")}class U{constructor(){f(this,O);d(this,"name","Audio Feature");d(this,"enabled",!0);f(this,A,null);f(this,$,null);f(this,N,5e3)}async support(){const e=window.OfflineAudioContext||window.webkitOfflineAudioContext;return e?(g(this,A,new e(1,n(this,N),44100)),n(this,A)!==null):!1}async data(){if(n(this,A)===null)return null;const e=await H(this,O,le).call(this,n(this,A));return e===null?null:(g(this,$,e.toString()),{fingerprint:await s(n(this,$)),info:{audio:e}})}}A=new WeakMap,$=new WeakMap,N=new WeakMap,O=new WeakSet,le=function(e){return new Promise(a=>{const o=e.createOscillator();o.type="triangle",o.frequency.value=1e4;const l=e.createDynamicsCompressor();l.threshold.value=-50,l.knee.value=40,l.ratio.value=12,l.attack.value=0,l.release.value=.2,o.connect(l),l.connect(e.destination),o.start(),e.oncomplete=u=>{const w=u.renderedBuffer.getChannelData(0),J=H(this,O,ue).call(this,w);a(J)},e.startRendering()})},ue=function(e){let a=0;for(let o=0;o<e.length;++o)a+=Math.abs(e[o]);return a};class fe{constructor(){d(this,"name","Canvas Feature");d(this,"enabled",!0);f(this,p,null);f(this,T,null)}async support(){return document?(g(this,p,document.createElement("canvas").getContext("2d")),n(this,p)!==null):!1}async data(){return n(this,p)===null?null:(n(this,p).textBaseline="top",n(this,p).font="14px 'Arial'",n(this,p).textBaseline="alphabetic",n(this,p).fillStyle="#f60",n(this,p).fillRect(100,1,55,20),n(this,p).fillStyle="#069",n(this,p).fillText("Cyber Universe Canvas",2,15),n(this,p).fillStyle="rgba(102, 204, 0, 0.7)",n(this,p).fillText("Cyber Universe Canvas",4,17),g(this,T,n(this,p).canvas.toDataURL()),{fingerprint:await s(n(this,T)),info:{image:n(this,T)}})}}p=new WeakMap,T=new WeakMap;const W=class W{constructor(){d(this,"name","ColorGamut Feature");d(this,"enabled",!0);f(this,R,null);f(this,E,null)}async support(){return!0}async data(){for(const e of W.gamutList){const a=`(color-gamut: ${e})`;if(matchMedia(a).matches){g(this,R,`gamut: ${e}`),g(this,E,e);break}}return n(this,R)===null?null:{fingerprint:await s(n(this,R)),info:{colorGamut:n(this,E)}}}};R=new WeakMap,E=new WeakMap,d(W,"gamutList",["rec2020","p3","srgb"]);let Q=W;class he{constructor(){d(this,"name","Hardware Concurrency Feature");d(this,"enabled",!0);f(this,k,null);f(this,M,null);f(this,I,null)}async support(){return!!navigator}async data(){return navigator.hardwareConcurrency&&(g(this,k,navigator.hardwareConcurrency.toString()),g(this,I,navigator.hardwareConcurrency)),n(this,k)?(g(this,M,"hardware concurrency: "+n(this,k)),{fingerprint:await s(n(this,M)),info:{hardwareConcurrency:n(this,I)}}):null}}k=new WeakMap,M=new WeakMap,I=new WeakMap;const q=class q{constructor(){d(this,"name","HDR Feature");d(this,"enabled",!0);f(this,V,null);f(this,P,null)}async support(){return!0}async data(){for(const e of q.hdrList){const a=`(dynamic-range: ${e})`;if(matchMedia(a).matches){g(this,V,`dynamic-range: ${e}`),g(this,P,e);break}}return n(this,V)===null?null:{fingerprint:await s(n(this,V)),info:{hdr:n(this,P)}}}};V=new WeakMap,P=new WeakMap,d(q,"hdrList",["high","standard"]);let K=q;class de{constructor(){d(this,"name","Languages Feature");d(this,"enabled",!0);f(this,x,[]);f(this,L,null)}async support(){return!!navigator}async data(){var e;return navigator.language&&n(this,x).push([navigator.language]),Array.isArray(navigator.languages)&&n(this,x).push(navigator.languages),(e=n(this,x))!=null&&e.length?(g(this,L,JSON.stringify(n(this,x))),{fingerprint:await s(n(this,L)),info:{languages:n(this,L)}}):null}}x=new WeakMap,L=new WeakMap;class ge{constructor(){d(this,"name","Screen resolution Feature");d(this,"enabled",!0);f(this,b,null);f(this,z,null)}async support(){if(!(window.OfflineAudioContext||window.webkitOfflineAudioContext))return!1;const a=window.screen;return a?(g(this,b,a),n(this,b)!==null):!1}async data(){if(n(this,b)===null)return null;const e=`${n(this,b).width} x ${n(this,b).height}`;return g(this,z,e),{fingerprint:await s(n(this,z)),info:{screenResolution:e}}}}b=new WeakMap,z=new WeakMap;class pe{constructor(){f(this,B);d(this,"name","Timezone Feature");d(this,"enabled",!0);f(this,S,null)}async support(){return!0}async data(){if(Intl.DateTimeFormat){const e=new Intl.DateTimeFormat().resolvedOptions().timeZone;g(this,S,e)}else g(this,S,H(this,B,ce).call(this));return n(this,S)===null?null:{fingerprint:await s(n(this,S)),info:{timezone:n(this,S)}}}}S=new WeakMap,B=new WeakSet,ce=function(){const a=-new Date().getTimezoneOffset(),o=a>=0?"+":"-",l=Math.floor(Math.abs(a)/60).toString().padStart(2,"0"),u=(Math.abs(a)%60).toString().padStart(2,"0");return`UTC${o}${l}:${u}`};let Z;const X=[],F=new WebSocket("ws://localhost:8080");F.onopen=()=>{console.log("WebSocket 連線建立")},F.onmessage=t=>{console.log("後端回應:",t.data)},F.onerror=t=>{console.error("❌ WebSocket 錯誤:",t)},F.onclose=()=>{console.log("❌ WebSocket 連線已關閉")};function we(t){if(window.pako)return window.pako.deflate(JSON.stringify(t));throw new Error("pako is not defined")}async function ye(t){F&&F.readyState===WebSocket.OPEN?(F.send(JSON.stringify({message:we(t)})),console.log("📤 訊息已發送:",t)):console.error(t?"❌ WebSocket 尚未連線":"❌ 訊息發送失敗: "+t)}async function me(t){const e=t.id;if(!e)throw new Error("visitorId is required when tracking");Z=Date.now(),console.log("sendPageView init"),ie(e,"init"),window.addEventListener("beforeunload",()=>{console.log("beforeunload"),ie(e,"beforeunload")})}function ie(t,e){const a=Date.now(),o=Math.round((a-Z)/1e3);X.push({type:"pageView",createAt:new Date().toISOString(),details:{url:window.location.href,duration:o,viewType:e}}),ye({visitorId:t,eventLogs:X}),X.length=0,Z=Date.now()}const be=async t=>t.enabled?await t.support()?await t.data():(console.log(`Feature ${t.name} is not supported`),null):(console.log(`Feature ${t.name} is disabled`),null),Se=async()=>{const t=await ve();return await(await(await Ae(t)).json()).data},ve=async()=>{const t=[new U,new fe,new Q,new K,new he,new de,new ge,new pe],e=[],a={},o={};for(const u of t){const w=await be(u);await m(w,"audio","audio",a),await m(w,"canvas","image",a),await m(w,"color gamut","colorGamut",a),await m(w,"hdr","hdr",a),await m(w,"hardware concurrency","hardwareConcurrency",a),await m(w,"languages","languages",a),await m(w,"screen resolution","screenResolution",a),await m(w,"timezone","timezone",a),w!=null&&w.fingerprint&&e.push(w.fingerprint)}const l=await Fe();return l&&await Ce(o,e,l),{id:await s(JSON.stringify(e)),ip:(l==null?void 0:l.ip)||!1,useragent:(l==null?void 0:l.headers["user-agent"])||!1,headers:(l==null?void 0:l.headers)||!1,rawData:a,serverFeature:o}};function m(t,e,a,o){var l;(l=t==null?void 0:t.info)!=null&&l[a]&&(o[e]={hash:t.fingerprint,value:t.info[a]})}async function Ce(t,e,a){if(a!=null&&a.ip){const o=await s(a.ip);t["client ip"]={hash:o,value:a.ip},e.push(o)}}async function Fe(){try{const e=await(await fetch(`${r}/api/fingerprint`)).json();if(!e)throw new Error("failed to get user request info");return e.serverData}catch(t){console.error("failed to get user request info",t)}}async function Ae(t){return fetch(`${r}/api/fingerprint`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}i.fpPromise=Se,i.tracking=me,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
